version: '3.8'

services:
  # Oracle Database 19c for RCU schemas (certified for FMW 14c)
  oracle-db:
    image: gvenzl/oracle-free:23-slim
    container_name: oracle-db-production
    hostname: oracle-db
    ports:
      - "${DB_PORT:-1521}:1521"
    environment:
      - ORACLE_PASSWORD=${DB_PASSWORD:-Oracle123}
      - APP_USER=${DB_APP_USER:-rcu_user}
      - APP_USER_PASSWORD=${DB_APP_PASSWORD:-Oracle123}
    volumes:
      - oracle_db_data:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    shm_size: ${DB_SHM_SIZE:-1gb}
    restart: unless-stopped
    networks:
      - oracle-forms-network

  # Oracle Forms & Reports 14c - Production Image with baked-in installation
  oracle-forms:
    build:
      context: .
      dockerfile: Dockerfile.production
    image: oracle-forms-14c-production:latest
    container_name: oracle-forms-production
    hostname: oracle-forms

    # Port mappings
    ports:
      - "${VNC_PORT:-5901}:5901"           # VNC access
      - "${ADMIN_PORT:-7001}:7001"         # WebLogic Admin Console
      - "${FORMS_PORT:-9001}:9001"         # Forms Server
      - "${REPORTS_PORT:-9002}:9012"       # Reports Server (container uses 9012)
      - "${WLS_PORT1:-5556}:5556"          # WebLogic additional ports
      - "${WLS_PORT2:-5557}:5557"

    # Volume mappings - Config files are externally mounted for customization
    volumes:
      # Forms configuration and source files
      - ./config/forms:/u01/app/oracle/middleware/config/forms:rw
      - ./forms_source:/home/oracle/forms_source:rw

      # Reports configuration and source files
      - ./config/reports:/u01/app/oracle/middleware/config/reports:rw
      - ./reports_source:/home/oracle/reports_source:rw
      - ./reports_temp:/home/oracle/reports_temp:rw

      # TNS names for database connections
      - ./config/tnsnames:/u01/app/oracle/middleware/config/tnsnames:rw

      # Domain logs (optional, for troubleshooting)
      - ./logs:/u01/app/oracle/middleware/logs:rw

    # Environment variables
    environment:
      - DISPLAY=:1
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1280x1024}
      - VNC_PASSWORD=${VNC_PASSWORD:-Oracle123}
      - ORACLE_BASE=/u01/app/oracle
      - ORACLE_HOME=/u01/app/oracle/middleware/fmw
      - JAVA_HOME=/u01/app/oracle/middleware/jdk17
      - MW_HOME=/u01/app/oracle/middleware
      - DOMAIN_HOME=/u01/app/oracle/middleware/fmw/user_projects/domains/base_domain
      - AUTO_START_SERVICES=${AUTO_START_SERVICES:-true}

      # WebLogic credentials
      - WLS_USER=${WLS_USER:-weblogic}
      - WLS_PW=${WLS_PW:-Oracle123}

      # Database connection (for Forms/Reports to connect to oracle-db)
      - DB_HOST=oracle-db
      - DB_PORT=1521
      - DB_SERVICE=${DB_SERVICE:-FREEPDB1}
      - DB_USERNAME=${DB_APP_USER:-rcu_user}
      - DB_PASSWORD=${DB_APP_PASSWORD:-Oracle123}

    # Use custom entrypoint for auto-start functionality
    user: root

    # Shared memory for Oracle (required)
    shm_size: ${SHM_SIZE:-2gb}

    # Resource limits
    mem_limit: ${MEM_LIMIT:-12g}
    mem_reservation: ${MEM_RESERVATION:-8g}
    cpus: ${CPUS:-4}

    # Restart policy
    restart: unless-stopped

    # Depends on database
    depends_on:
      oracle-db:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/console"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5m

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels for organization
    labels:
      com.oracle.forms.version: "14.1.2.0"
      com.oracle.forms.type: "production"
      com.oracle.forms.description: "Production-ready Oracle Forms & Reports with auto-start"

    networks:
      - oracle-forms-network

  # Optional: Nginx reverse proxy for better external access
  nginx:
    image: nginx:alpine
    container_name: oracle-forms-proxy
    ports:
      - "${PROXY_HTTP_PORT:-8880}:80"
      - "${PROXY_HTTPS_PORT:-8443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # - ./ssl:/etc/nginx/ssl:ro  # Uncomment for SSL certificates
    depends_on:
      - oracle-forms
    restart: unless-stopped
    profiles:
      - proxy  # Use 'docker-compose -f docker-compose.production.yml --profile proxy up' to include
    networks:
      - oracle-forms-network

# Volumes definition
volumes:
  oracle_db_data:
    driver: local

# Network configuration
networks:
  oracle-forms-network:
    name: oracle-forms-network
    driver: bridge
