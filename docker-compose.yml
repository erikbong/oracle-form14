version: '3.8'

services:
  # Oracle Forms & Reports 14c - Main Service
  oracle-forms:
    # Build configuration (commented out - using existing local image)
    # build:
    #   context: .
    #   dockerfile: Dockerfile

    # Use local image OR Docker Hub image (uncomment one):
    image: bbquerre/oracle-forms-14c:latest                    # Local image
    # image: bbquerre/oracle-forms-14c:latest         # Docker Hub image

    container_name: oracle-forms-14c
    hostname: oracle-forms

    # Port mappings
    ports:
      - "${VNC_PORT:-5901}:5901"           # VNC access
      - "${ADMIN_PORT:-7001}:7001"         # WebLogic Admin Console
      - "${FORMS_PORT:-9001}:9001"         # Forms Server
      - "${REPORTS_PORT:-9002}:9012"       # Reports Server (container uses 9012)
      - "${WLS_PORT1:-5556}:5556"          # WebLogic additional ports
      - "${WLS_PORT2:-5557}:5557"

    # Volume mappings
    volumes:
      # OPTIONAL: Mount Oracle directory from host (for development/override)
      # Uncomment this line if you want to use host Oracle folder instead of baked-in version
      # NOTE: Currently required because image doesn't have Oracle baked in yet
      - ./Oracle:/u01/app/oracle/middleware:rw

      # Installation files (read-only) - for manual installation if needed
      - ./install:/install:ro

      # Entrypoint script
      - ./entrypoint.sh:/entrypoint.sh:ro

      # Forms FMB files (read-write)
      - ./forms_source:/home/oracle/forms_source:rw

      # Reports RDF files (read-write)
      - ./reports_source:/home/oracle/reports_source:rw

      # Reports temporary files (read-write)
      - ./reports_temp:/home/oracle/reports_temp:rw

      # Configuration files (external)
      - ./config/forms:/u01/app/oracle/middleware/config/forms:rw
      - ./config/reports:/u01/app/oracle/middleware/config/reports:rw
      - ./config/tnsnames:/u01/app/oracle/middleware/config/tnsnames:rw

      # Logs directory
      - ./logs:/u01/app/oracle/middleware/logs:rw

      # Scripts and utilities (read-only)
      - ./scripts:/scripts:ro

    # Environment variables
    environment:
      - DISPLAY=:1
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1280x1024}
      - VNC_PASSWORD=${VNC_PASSWORD:-Oracle123}

      # Oracle paths
      - ORACLE_BASE=/u01/app/oracle
      - ORACLE_HOME=/u01/app/oracle/middleware/fmw
      - JAVA_HOME=/u01/app/oracle/middleware/jdk17
      - MW_HOME=/u01/app/oracle/middleware
      - DOMAIN_HOME=/u01/app/oracle/middleware/fmw/user_projects/domains/base_domain

      # Auto-start configuration
      - AUTO_START_SERVICES=${AUTO_START_SERVICES:-true}

      # WebLogic credentials
      - WLS_USER=${WLS_USER:-weblogic}
      - WLS_PW=${WLS_PW:-Oracle123}

      # Database connection (for Forms/Reports to connect to oracle-db)
      - DB_HOST=oracle-db
      - DB_PORT=1521
      - DB_SERVICE=${DB_SERVICE:-FREEPDB1}
      - DB_USERNAME=${DB_APP_USER:-rcu_user}
      - DB_PASSWORD=${DB_APP_PASSWORD:-Oracle123}

    # Run as root (entrypoint will switch to oracle user)
    user: root

    # Use custom entrypoint for auto-start functionality
    entrypoint: ["/bin/bash", "/entrypoint.sh"]

    # Shared memory for Oracle (required)
    shm_size: ${SHM_SIZE:-2gb}

    # Resource limits
    mem_limit: ${MEM_LIMIT:-12g}
    mem_reservation: ${MEM_RESERVATION:-8g}
    cpus: ${CPUS:-4}

    # Restart policy
    restart: unless-stopped

    # Depends on database
    depends_on:
      oracle-db:
        condition: service_healthy

    # Health check - checks both VNC and WebLogic
    healthcheck:
      test: ["CMD-SHELL", "vncserver -list && curl -f http://localhost:7001/console || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 5m

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Labels for organization
    labels:
      com.oracle.forms.version: "14.1.2.0"
      com.oracle.forms.type: "production"
      com.oracle.forms.description: "Oracle Forms & Reports 14c with auto-start"

    networks:
      - oracle-forms-network

  # Oracle Database 23c Free with RCU schemas pre-installed
  oracle-db:
    image: bbquerre/oracle-db-with-rcu:latest
    container_name: oracle-db
    hostname: oracle-db

    ports:
      - "${DB_PORT:-1521}:1521"

    environment:
      - ORACLE_PASSWORD=${DB_PASSWORD:-Oracle123}
      - APP_USER=${DB_APP_USER:-rcu_user}
      - APP_USER_PASSWORD=${DB_APP_PASSWORD:-Oracle123}

    # NOTE: No volume needed - RCU data is baked into the image!
    # Uncomment below if you want to persist data changes:
    # volumes:
    #   - oracle_db_data:/opt/oracle/oradata

    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    shm_size: ${DB_SHM_SIZE:-1gb}

    restart: unless-stopped

    networks:
      - oracle-forms-network

# Volumes definition
volumes:
  oracle_db_data:
    driver: local

# Network configuration
networks:
  oracle-forms-network:
    name: oracle-forms-network
    driver: bridge
